{% extends 'matches/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'matches/match_detail.css' %}">
{% endblock %}

{% block content %}
<div class="detail-wrapper">
    <a href="{% url 'home' %}" class="back-btn-modern">
        <i class="fa-solid fa-chevron-left"></i> Wróć do wyników
    </a>

    <div class="match-card-premium">
        <div class="scoreboard-header">
            <div class="team-block">
                <span class="team-name-lg">{{ match.home_team.name }}</span>
            </div>
            <div class="score-center">
                <div class="main-score">{{ match.home_score }} - {{ match.away_score }}</div>
                <div class="status-badge">
                    <span class="pulse-icon"></span>
                    {{ match.status }} {% if match.time_elapsed %}/ {{ match.time_elapsed }}'{% endif %}
                </div>
            </div>
            <div class="team-block">
                <span class="team-name-lg">{{ match.away_team.name }}</span>
            </div>
        </div>

        <div class="match-tabs">
            <button class="tab-btn active" onclick="openTab(event, 'timeline-tab')">Oś czasu</button>
            <button class="tab-btn" onclick="openTab(event, 'lineups-tab')">Składy</button>
            <button class="tab-btn" onclick="openTab(event, 'stats-tab')">Statystyki</button>
        </div>

        {# ======================= OŚ CZASU ======================= #}
        <div id="timeline-tab" class="tab-content" style="display: block;">
            <div class="timeline-container">
                {% for event in events %}
                <div class="feed-row {{ event.side }}">

                    <div class="feed-time">
                        {{ event.formatted_time }}{% if event.formatted_time %}'{% endif %}
                    </div>

                    {# ---------- PERIOD (HT / FT) ---------- #}
                    {% if event.is_period_marker %}
                    <div class="feed-badge period-badge">
                        {% if event.text == 'HT' %}HT{% elif event.text == 'FT' %}FT{% elif event.time == 45 %}HT{% else%}FT{% endif %}
                    </div>
                    <div class="feed-info period-info">
                        {% if event.text == 'HT' or event.time == 45 %}
                        Koniec pierwszej połowy
                        {% elif event.text == 'FT' or event.time == 90 %}
                        Koniec meczu
                        {% elif event.text %}
                        {{ event.text }}
                        {% else %}
                        Przerwa
                        {% endif %}
                        {% if event.running_score %}
                        <span class="period-score">{{ event.running_score }}</span>
                        {% endif %}
                    </div>

                    {# ---------- INJURY TIME ---------- #}
                    {% elif event.is_injury_time_announcement %}
                    <div class="feed-badge injurytime-badge">
                        <i class="fa-regular fa-clock"></i>
                    </div>
                    <div class="feed-info injurytime-info">
                        Sędzia dolicza: <strong>+{{ event.length|default:event.added_time }} min</strong>
                    </div>

                    {# ---------- VAR DECISION ---------- #}
                    {% elif event.is_var_decision %}
                    <div class="feed-card var-card">
                        <div class="feed-icon">
                            <i class="fa-solid fa-display var-icon"></i>
                        </div>
                        <div class="feed-details">
                            <span class="player-name">{{ event.player_name }}</span>
                            <span class="var-label">
                                VAR:
                                {% if event.confirmed %}
                                <span class="var-confirmed"><i class="fa-solid fa-check"></i> Potwierdzone</span>
                                {% elif event.confirmed == False %}
                                <span class="var-overturned"><i class="fa-solid fa-xmark"></i> Odrzucone</span>
                                {% else %}
                                <span class="var-pending">W trakcie analizy</span>
                                {% endif %}
                            </span>
                            {% if event.incident_class_label %}
                            <span class="sub-info">({{ event.incident_class_label }})</span>
                            {% endif %}
                        </div>
                    </div>

                    {# ---------- STANDARD EVENTS ---------- #}
                    {% else %}
                    <div class="feed-card">
                        <div class="feed-icon">

                            {# --- GOL --- #}
                            {% if event.is_goal %}
                            <i class="fa-solid fa-futbol goal-icon"></i>
                            {% if event.running_score %}
                            <span class="goal-score">{{ event.running_score }}</span>
                            {% endif %}

                            {# --- KARTKA --- #}
                            {% elif event.is_card %}
                            {% if event.card_color == 'red' %}
                            <div class="card-icon red"></div>
                            {% elif event.card_color == 'yellow-red' %}
                            <div class="card-icon-double">
                                <div class="card-icon yellow card-overlap"></div>
                                <div class="card-icon red card-overlap"></div>
                            </div>
                            {% else %}
                            <div class="card-icon yellow"></div>
                            {% endif %}

                            {# --- ZMIANA --- #}
                            {% elif event.is_substitution %}
                            <i class="fa-solid fa-right-left sub-icon"></i>

                            {# --- INNE --- #}
                            {% else %}
                            <i class="fa-solid fa-circle-info info-icon"></i>
                            {% endif %}
                        </div>

                        <div class="feed-details">
                            {# === GOL: szczegóły === #}
                            {% if event.is_goal %}
                            <span class="player-name">
                                {{ event.player_name }}
                                {% if event.incident_class_label %}
                                <span class="incident-tag">{{ event.incident_class_label }}</span>
                                {% endif %}
                            </span>
                            {% if event.assist_player_name %}
                            <span class="sub-info">
                                <i class="fa-solid fa-shoe-prints" style="font-size:0.7rem;"></i>
                                {{ event.assist_player_name }}
                            </span>
                            {% endif %}
                            {% if event.assist2_player_name %}
                            <span class="sub-info">
                                <i class="fa-solid fa-shoe-prints" style="font-size:0.7rem;"></i>
                                {{ event.assist2_player_name }}
                            </span>
                            {% endif %}

                            {# === KARTKA: szczegóły === #}
                            {% elif event.is_card %}
                            <span class="player-name">
                                {{ event.player_name }}
                                {% if event.rescinded %}
                                <span class="rescinded-tag">ANULOWANA</span>
                                {% endif %}
                            </span>
                            {% if event.reason %}
                            <span class="sub-info">{{ event.reason }}</span>
                            {% endif %}
                            {% if event.incident_class_label %}
                            <span class="sub-info card-type-label">{{ event.incident_class_label }}</span>
                            {% endif %}

                            {# === ZMIANA: szczegóły === #}
                            {% elif event.is_substitution %}
                            <span class="sub-detail">
                                <i class="fa-solid fa-arrow-up" style="color: #10b981;"></i>
                                <span class="player-name">{{ event.display_player_in }}</span>

                            </span>
                            {% if event.display_player_out %}
                            <span class="sub-detail">
                                <i class="fa-solid fa-arrow-down" style="color: #ef4444;"></i>
                                <span class="player-out">{{ event.display_player_out }}</span>
                                {% if event.injury %}
                                <i class="fa-solid fa-kit-medical injury-badge" title="Kontuzja"></i>
                                {% endif %}
                            </span>
                            {% endif %}

                            {# === INNE === #}
                            {% else %}
                            <span class="player-name">{{ event.player_name }}</span>
                            {% if event.text %}
                            <span class="sub-info">{{ event.text }}</span>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% empty %}
                <p class="no-data">Brak zdarzeń.</p>
                {% endfor %}
            </div>
        </div>

        {# ======================= SKŁADY ======================= #}
        <div id="lineups-tab" class="tab-content" style="display: none;">

            {# ══════ BOISKO ══════ #}
            <div class="pitch-container">
                {# Header z nazwami drużyn i formacjami #}
                <div class="pitch-teams-header">
                    <div class="team-header-home">
                        {{ match.home_team.name }}
                        {% if match.home_formation %}<span class="formation-tag">{{ match.home_formation }}</span>
                        {% endif %}
                    </div>
                    <div class="team-header-away">
                        {% if match.away_formation %}<span class="formation-tag">{{ match.away_formation }}</span>
                        {% endif %}
                        {{ match.away_team.name }}
                    </div>
                </div>

                {# Pitch markings #}
                <div class="pitch-field">
                    <div class="pitch-half-line"></div>
                    <div class="pitch-center-circle"></div>
                    <div class="pitch-center-dot"></div>

                    <div class="pitch-penalty-box pitch-penalty-left"></div>
                    <div class="pitch-penalty-box pitch-penalty-right"></div>

                    <div class="pitch-goal-box pitch-goal-left"></div>
                    <div class="pitch-goal-box pitch-goal-right"></div>

                    <div class="pitch-corner pitch-corner-tl"></div>
                    <div class="pitch-corner pitch-corner-tr"></div>
                    <div class="pitch-corner pitch-corner-bl"></div>
                    <div class="pitch-corner pitch-corner-br"></div>


                    {# Home players #}
                    {% if pitch_home %}
                    {% for item in pitch_home %}
                    <div class="pitch-player home-player" style="--p-top: {{ item.top }}%; --p-left: {{ item.left }}%;">
                        <div class="pitch-player-circle {% if item.player.is_captain %}captain-circle{% endif %}">
                            {{ item.player.shirt_number|default:"" }}
                        </div>
                        <div class="pitch-player-name">
                            {{ item.player.player_name|truncatewords:2 }}
                        </div>
                        {% if item.player.avg_rating %}
                        <div class="pitch-rating {{ item.rating_class }}">
                            {{ item.player.avg_rating }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% endif %}

                    {# Away players #}
                    {% if pitch_away %}
                    {% for item in pitch_away %}
                    <div class="pitch-player away-player" style="--p-top: {{ item.top }}%; --p-left: {{ item.left }}%;">
                        <div class="pitch-player-circle {% if item.player.is_captain %}captain-circle{% endif %}">
                            {{ item.player.shirt_number|default:"" }}
                        </div>
                        <div class="pitch-player-name">
                            {{ item.player.player_name|truncatewords:2 }}
                        </div>
                        {% if item.player.avg_rating %}
                        <div class="pitch-rating {{ item.rating_class }}">
                            {{ item.player.avg_rating }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% endif %}

                    {% if not pitch_home and not pitch_away %}
                    <div class="pitch-empty-state">
                        <div class="pitch-empty-icon">
                            <i class="fa-solid fa-people-group"></i>
                        </div>
                        <div class="pitch-empty-text">
                            Składy na boisku niedostępne
                        </div>
                    </div>
                    {% endif %}

                </div>
            </div>

            {# ══════ REZERWA ══════ #}
            <div class="subs-section">
                <div class="subs-half">
                    <div class="subs-title"><i class="fa-solid fa-arrow-right-arrow-left"></i> Rezerwa – {{match.home_team.name }}</div>
                    <div class="subs-grid">
                        {% for player in lineups.home_subs %}
                        <div class="sub-card">
                            <span class="sub-num">{{ player.shirt_number|default:"–" }}</span>
                            <span class="sub-name">{{ player.player_name }}</span>
                            <span class="sub-pos">{{ player.position_label }}</span>
                        </div>
                        {% empty %}
                        <p class="no-data">Brak danych.</p>
                        {% endfor %}
                    </div>
                </div>
                <div class="subs-half">
                    <div class="subs-title"><i class="fa-solid fa-arrow-right-arrow-left"></i>Rezerwa - {{match.away_team.name }}</div>
                    <div class="subs-grid">
                        {% for player in lineups.away_subs %}
                        <div class="sub-card">
                            <span class="sub-num">{{ player.shirt_number|default:"–" }}</span>
                            <span class="sub-name">{{ player.player_name }}</span>
                            <span class="sub-pos">{{ player.position_label }}</span>
                        </div>
                        {% empty %}
                        <p class="no-data">Brak danych.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            {# ══════ BRAKUJĄCY / NIEPEWNI ══════ #}
            {% if missing_home or missing_away %}
            <div class="subs-section missing-section">
                <div class="subs-half">
                    {% if missing_home %}
                    <div class="subs-title"><i class="fa-solid fa-user-injured"></i> Kontuzje i Zawieszenia – {{ match.home_team.name}}</div>
                    <div class="subs-grid">
                        {% for player in missing_home %}
                        <div class="sub-card missing-card">
                            <span class="sub-num"><i class="fa-solid fa-ban"></i></span>
                            <span class="sub-name">{{ player.player_name }}</span>
                            <span class="sub-pos status-{{ player.type }}">{{ player.type|upper }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div class="subs-half">
                    {% if missing_away %}
                    <div class="subs-title"><i class="fa-solid fa-user-injured"></i> Kontuzje i Zawieszenia – {{ match.away_team.name}}</div>
                    <div class="subs-grid">
                        {% for player in missing_away %}
                        <div class="sub-card missing-card">
                            <span class="sub-num"><i class="fa-solid fa-ban"></i></span>
                            <span class="sub-name">{{ player.player_name }}</span>
                            <span class="sub-pos status-{{ player.type }}">{{ player.type|upper }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <div id="stats-tab" class="tab-content" style="display: none;">
            <p class="no-data">Statystyki niedostępne.</p>
        </div>

    </div>
</div>

<script>
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }
</script>
{% endblock %}